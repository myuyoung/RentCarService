events {
    worker_connections 1024;
}

# nginx 설정 파일 - Spring Boot + WebSocket 지원
# 이 파일을 /etc/nginx/sites-available/wook 로 복사하고 사용하세요

http {
    server {
        listen 8080;
        server_name localhost;  # 실제 도메인으로 변경하세요
        
        # 로그 설정
        access_log logs/wook_access.log;
        error_log logs/wook_error.log;
        
        # 기본 애플리케이션 프록시
        location / {
            proxy_pass http://localhost:7950;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $server_name;
            
            # 타임아웃 설정
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
        
        # WebSocket 전용 프록시 설정 (핵심!)
        location /ws-stomp/ {
            proxy_pass http://localhost:7950/ws-stomp/;
            
            # WebSocket 업그레이드를 위한 필수 헤더들
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $server_name;
            
            # WebSocket 연결 유지를 위한 긴 타임아웃
            proxy_read_timeout 86400;
            proxy_send_timeout 86400;
            proxy_connect_timeout 86400;
            
            # 버퍼링 비활성화 (실시간 통신을 위해)
            proxy_buffering off;
        }
        
        # 정적 리소스 캐싱 (성능 최적화)
        location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg)$ {
            proxy_pass http://localhost:7950;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 캐시 설정
            expires 1h;
            add_header Cache-Control "public, immutable";
            
            # 압축 설정
            gzip on;
            gzip_vary on;
            gzip_proxied any;
            gzip_comp_level 6;
            gzip_types text/css application/javascript image/svg+xml;
        }
        
        # 이미지 업로드 경로 (Spring Boot에서 처리)
        location /api/files/ {
            proxy_pass http://localhost:7950;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 파일 업로드를 위한 크기 제한
            client_max_body_size 10M;
        }
        
        # 개발용 도구들 (필요시 제거)
        location /h2-console/ {
            proxy_pass http://localhost:7950/h2-console/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /actuator/ {
            proxy_pass http://localhost:7950/actuator/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # HTTPS 설정 (SSL 인증서가 있는 경우)
    # server {
    #     listen 443 ssl http2;
    #     server_name your-domain.com;
    #     
    #     ssl_certificate /path/to/your/certificate.crt;
    #     ssl_certificate_key /path/to/your/private.key;
    #     
    #     # 위의 location 블록들을 여기에 복사
    # }
}